<!DOCTYPE html>
<html>
<head>
  <title>NCCGA Regional Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; padding:0; }
    #map { height: 100vh; }

    /* Search UI */
   .search-wrap{
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);   /* center horizontally */
  z-index: 1000;
  width: min(280px, 92vw);        /* roomy on desktop, fits on mobile */
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

    .search-input{
      width:100%; box-sizing:border-box;
      padding:10px 12px; border:1px solid #bbb; border-radius:8px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1); outline:none; background:#fff;
    }
    .search-input:focus{ border-color:#4e7cf1; box-shadow:0 0 0 3px rgba(78,124,241,.15); }
    .results{
      margin-top:6px; background:#fff; border:1px solid #ddd; border-radius:8px; overflow:hidden;
      box-shadow:0 8px 18px rgba(0,0,0,.12); max-height:320px; overflow-y:auto; display:none;
    }
    .result-item{
      padding:8px 10px; cursor:pointer; display:flex; align-items:center; justify-content:space-between;
    }
    .result-item:hover, .result-item.active{ background:#f2f6ff; }
    .result-left{ display:flex; gap:8px; align-items:center; }
    .result-type{
      font-size:11px; text-transform:uppercase; letter-spacing:.04em; color:#666; background:#f3f3f3; padding:2px 6px; border-radius:6px;
    }
    .result-title{ font-size:14px; color:#222; }
    .result-sub{ font-size:12px; color:#666; }

    .qualifier-icon {
      filter: drop-shadow(0 0 2px #fff) drop-shadow(0 0 1.5px #000);
    }
    .leaflet-div-icon.flag-div { background: transparent; border: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Search UI -->
  <div class="search-wrap">
    <input id="searchInput" class="search-input" type="text" placeholder="Search schools, tournaments, qualifiers, regionsâ€¦" autocomplete="off">
    <div id="results" class="results"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Turf for point-in-polygon + buffering line regions -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script>
    const map = L.map('map').setView([39.5, -98.35], 4);

    // ===== Panes & stacking order =====
    map.createPane('regionPane');     map.getPane('regionPane').style.zIndex = 450;
    map.createPane('schoolPane');     map.getPane('schoolPane').style.zIndex = 650;
    map.createPane('tournamentPane'); map.getPane('tournamentPane').style.zIndex = 660;
    map.createPane('qualifierPane');  map.getPane('qualifierPane').style.zIndex = 670;

    // ---------- Normalizer (used for grouping keys only) ----------
    const clean = str => String(str || '')
      .toLowerCase()
      .replace(/region/g, '')
      .replace(/capitol/g, 'capital')
      .replace(/[\s\-_().]/g, '')
      .trim();

    // ---------- Fixed palette (yours) ----------
    const REGION_COLORS = {
      "Atlantic Region":             "#1f78b4",
      "Northeast Region":            "#33a02c",
      "Capitol Region":              "#e31a1c",
      "Colonial Region":             "#ff7f00",
      "North Carolina Region":       "#FF69B4",
      "Desert Region":               "#b15928",
      "Mountain Region":             "#a6cee3",
      "Pacific Region":              "#b2df8a",
      "Northwest Region":            "#fb9a99",
      "Ohio Valley Region":          "#fdbf6f",
      "Midwest Region":              "#cab2d6",
      "Southern New England Region": "#80cdc1",
      "Texas Region":                "#5e3c99",
      "Northern California Region":  "#c51b7d",
      "Southern California Region":  "#35978f",
      "Indiana Region":              "#80b1d3",
      "Northern New England Region": "#8B4513",
      "Twin Cities Region":          "#33a02c",
      "Great Lakes Region":          "#800000",
      "Philadelphia Region":         "#4B0082",
      "Metro Region":                "#000080",
      "Florida Region":              "#FF69B4",
      "Gulf Region":                 "#A2AD00",
      "Central Region":              "#9C27B0",
      "North Region":                "#CC5500",
      "Southeast Region":            "#C7EA46"
    };

    const COLOR_BY_KEY = {};
    Object.entries(REGION_COLORS).forEach(([name, color]) => {
      COLOR_BY_KEY[clean(name)] = color;
    });

    // Optional short aliases you might see in data
    const REGION_ALIASES = {
      philadelphia: 'colonial', philly: 'colonial',
      tx: 'texas',
      norcal: 'northerncalifornia', nocal: 'northerncalifornia',
      socal: 'southerncalifornia',  scal: 'southerncalifornia'
    };

    // Prefer the tournament's label; fall back to polygon if unknown
    const PREFER_TOURNAMENT_LABEL = true;

    function hashColor(name = "default") {
      let h = 0; for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) | 0;
      const hue = Math.abs(h) % 360; return `hsl(${hue},70%,45%)`;
    }
    function getRegionColorByName(name) {
      const key = clean(name);
      return COLOR_BY_KEY[key] || hashColor(name || "");
    }
    function resolveRegionKey(name) {
      const k = clean(name);
      if (COLOR_BY_KEY[k]) return k;
      const alias = REGION_ALIASES[k];
      if (alias && COLOR_BY_KEY[alias]) return alias;
      return k;
    }

    // Layers
    const schoolRegionLayer = L.layerGroup().addTo(map);
    const tournamentLayer   = L.layerGroup().addTo(map);
    const qualifierLayer    = L.layerGroup().addTo(map);

    // Basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const bottomCenterAnchor = size => [Math.round(size[0] / 2), size[1]];
    const loadJSON = (url) => fetch(url).then(r => { if (!r.ok) throw new Error(url+': '+r.status); return r.json(); });

    // === SVG tournament flag (cloth colorable) ===
    function makeSvgFlagIcon(color, size = [18, 24]) {
      const [w, h] = size;
      const html = `
        <svg width="${w}" height="${h}" viewBox="0 0 18 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <ellipse cx="9" cy="22" rx="6" ry="3" fill="#000"/>
          <rect x="8" y="3" width="2" height="18" fill="#000"/>
          <polygon points="10,6 10,12 18,9" fill="${color}"/>
        </svg>`;
      return L.divIcon({
        html,
        className: 'flag-div',
        iconSize: [w, h],
        iconAnchor: [Math.round(w/2), h],
        popupAnchor: [0, -Math.round(h*0.8)]
      });
    }

    // ===== Search Index =====
    const searchIndex = [];  // {type, title, sub, select(), terms}
    function addToIndex(entry){ searchIndex.push(entry); }

    // ===== Load data (regions first so we can color tournaments) =====
    Promise.all([
      loadJSON('regions.geojson'),
      loadJSON('schools.geojson').catch(() => null),
      loadJSON('tournaments.geojson').catch(() => null),
      loadJSON('qualifiers.geojson').catch(() => null),
    ]).then(([regions, schools, tournaments, qualifiers]) => {

      // --- Convert non-polygon region geometries into thin polygons for hit-testing ---
      function toPolygonFeature(feat) {
        const g = feat && feat.geometry ? feat.geometry : {};
        if (g.type === 'Polygon' || g.type === 'MultiPolygon') return feat;
        try {
          // buffer by ~5 km to create a polygon shell around lines
          return turf.buffer(feat, 5, { units: 'kilometers' });
        } catch {
          return feat; // fallback (won't match, but won't crash)
        }
      }

      // --- Build region polygon list for point-in-polygon coloring ---
      const regionPolys = (regions?.features || []).map(f => {
        const polyFeat = toPolygonFeature(f);
        return {
          feature: polyFeat,
          key: clean(f.properties?.region),
          name: f.properties?.region,
          color: getRegionColorByName(f.properties?.region)
        };
      });

      // Prefer label; fall back to polygon; final fallback = hashed color
      function colorAndKeyForPointOrLabel(lat, lng, labelName) {
        const labelKey = resolveRegionKey(labelName);
        const labelKnown = !!COLOR_BY_KEY[labelKey];

        if (PREFER_TOURNAMENT_LABEL && labelKnown) {
          return { color: COLOR_BY_KEY[labelKey], key: labelKey, name: labelName || '', source: 'label' };
        }

        const pt = turf.point([lng, lat]);
        for (const r of regionPolys) {
          if (turf.booleanPointInPolygon(pt, r.feature)) {
            return { color: r.color, key: r.key, name: r.name, source: 'polygon' };
          }
        }

        return { color: hashColor(labelName || ''), key: labelKey, name: labelName || '', source: 'fallback' };
      }

      // --- Visible region outlines (non-interactive) ---
      const regionsVisible = L.geoJSON(regions, {
        pane: 'regionPane',
        style: f => ({
          color: getRegionColorByName(f.properties?.region),
          weight: 2,
          fillOpacity: 0.2,
          interactive: false
        })
      }).addTo(schoolRegionLayer);

      // --- Schools (bottom layer; clicks must win) ---
      if (schools) {
        L.geoJSON(schools, {
          pane: 'schoolPane',
          pointToLayer: (feature, latlng) => {
            const p = feature.properties || {};
            const color = getRegionColorByName(p.region);
            const url = `https://nccga.org/app/teams/${p.slug}`;

            const m = L.circleMarker(latlng, {
              pane: 'schoolPane',
              radius: 6,
              fillColor: color,
              color: "#333",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.9,
              bubblingMouseEvents: false,
              interactive: true
            });

            m.on('click', e => {
              if (e.originalEvent) {
                L.DomEvent.stop(e.originalEvent);
                e.originalEvent._clickedSchool = true;
              }
              m.bindPopup(
                `<strong><a href="${url}" target="_blank">${p.school}</a></strong><br>${p.region}`
              ).openPopup();
              if (m.bringToFront) m.bringToFront();
            });

            // Add to search
            addToIndex({
              type: 'School',
              title: p.school,
              sub: p.region,
              terms: `${p.school} ${p.region}`.toLowerCase(),
              select: () => {
                map.setView(m.getLatLng(), Math.max(map.getZoom(), 9), { animate: true });
                m.fire('click');
              }
            });

            return m;
          }
        }).addTo(schoolRegionLayer);
      }

      // --- Storage for popup lists ---
      const tournamentsByRegionKey = {};
      const qualifiersByRegionKey  = {};

      // --- Tournaments (middle layer; label-preferred coloring) ---
      const TOURN_SIZE = [18, 24];

      if (tournaments) {
        L.geoJSON(tournaments, {
          pane: 'tournamentPane',
          pointToLayer: (feature, latlng) => {
            const p = feature.properties || {};
            const { color, key } = colorAndKeyForPointOrLabel(latlng.lat, latlng.lng, p.region);

            // keep for region popups
            (tournamentsByRegionKey[key] ||= []).push({ ...p });

            const marker = L.marker(latlng, {
              icon: makeSvgFlagIcon(color, TOURN_SIZE),
              pane: 'tournamentPane',
              zIndexOffset: 0
            });

            // bind popup
            const html = (() => {
              let s = `<strong>${p.course_name || 'Tournament'}</strong>`;
              if (p.region) s += `<br>${p.region}`;
              if (p.date)   s += `<br><em>${p.date}</em>`;
              if (p.website) s += `<br><a href="${p.website}" target="_blank">Course Website</a>`;
              return s;
            })();
            marker.bindPopup(html);

            // Add to search
            addToIndex({
              type: 'Tournament',
              title: p.course_name || 'Tournament',
              sub: p.region || '',
              terms: `${p.course_name || ''} ${p.region || ''}`.toLowerCase(),
              select: () => {
                map.setView(marker.getLatLng(), Math.max(map.getZoom(), 9), { animate: true });
                marker.openPopup();
              }
            });

            return marker;
          }
        }).addTo(tournamentLayer);
      }

      // --- Qualifiers (top layer; PNG icon) ---
      const QUAL_SIZE = [26, 26];
      const qualifierIcon = L.icon({
        iconUrl: 'img/Qualifier_flag_icon.png',
        iconSize: QUAL_SIZE,
        iconAnchor: bottomCenterAnchor(QUAL_SIZE),
        popupAnchor: [0, -Math.round(QUAL_SIZE[1] * 0.9)],
        className: 'qualifier-icon'
      });

      if (qualifiers) {
        L.geoJSON(qualifiers, {
          pane: 'qualifierPane',
          pointToLayer: (feature, latlng) => {
            const p = feature.properties || {};

            const marker = L.marker(latlng, {
              icon: qualifierIcon,
              pane: 'qualifierPane',
              zIndexOffset: 100
            });

            const label = Array.isArray(p.regions) ? p.regions.join(', ') : (p.region || 'Qualifier');
            let html = `<strong>${p.course_name || 'Qualifier'}</strong><br>${label}`;
            if (p.date) html += `<br><em>${p.date}</em>`;
            if (p.website) html += `<br><a href="${p.website}" target="_blank">Course Website</a>`;
            marker.bindPopup(html);

            // Index by given region labels (if any)
            const keys = Array.isArray(p.regions)
              ? p.regions
              : (typeof p.region === 'string' ? p.region.split(',').map(s => s.trim()).filter(Boolean) : []);
            const keyList = keys.length ? keys.map(l => clean(l)) : [clean(p.region || '')];
            keyList.forEach(k => (qualifiersByRegionKey[k] ||= []).push(p));

            // Add to search
            addToIndex({
              type: 'Qualifier',
              title: p.course_name || 'Qualifier',
              sub: label,
              terms: `${p.course_name || ''} ${label}`.toLowerCase(),
              select: () => {
                map.setView(marker.getLatLng(), Math.max(map.getZoom(), 9), { animate: true });
                marker.openPopup();
              }
            });

            return marker;
          }
        }).addTo(qualifierLayer);
      }

      // --- Invisible interactive region layer for popups/zoom + add regions to search ---
      regions.features.forEach(regionFeature => {
        const regionName = regionFeature.properties?.region || 'Region';
        const key = clean(regionName);
        const schoolsList = regionFeature.properties?.schools || [];
        const tList = tournamentsByRegionKey[key] || [];
        const qList = qualifiersByRegionKey[key] || [];

        const schoolsHtml = (schoolsList.length
          ? schoolsList.map(s => `<li>${s}</li>`).join('')
          : '<li>No schools listed.</li>');

        const tournamentsHtml = (tList.length
          ? tList.map(t => {
              let html = `<li><strong>${t.course_name || 'Tournament'}</strong>`;
              if (t.date) html += `<br><em>${t.date}</em>`;
              if (t.website) html += `<br><a href="${t.website}" target="_blank">Course Website</a>`;
              html += `</li>`;
              return html;
            }).join('')
          : '<li>No tournaments scheduled.</li>');

        const qListHtml = (qList.length
          ? qList.map(q => {
              let html = `<li><strong>${q.course_name || q.course || 'Qualifier'}</strong>`;
              if (q.date) html += `<br><em>${q.date}</em>`;
              if (q.website) html += `<br><a href="${q.website}" target="_blank">Course Website</a>`;
              html += `</li>`;
              return html;
            }).join('')
          : '<li>No qualifiers scheduled.</li>');

        const popupContent = `
          <div style="min-width:300px;">
            <h4 style="margin:0 0 10px 0; text-align:center;">${regionName}</h4>
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div style="width:32%; min-width:220px;">
                <strong>Schools:</strong>
                <ul style="padding-left:18px; margin-top:4px;">${schoolsHtml}</ul>
              </div>
              <div style="width:32%; min-width:220px;">
                <strong>Tournaments:</strong>
                <ul style="padding-left:18px; margin-top:4px;">${tournamentsHtml}</ul>
              </div>
              <div style="width:32%; min-width:220px;">
                <strong>Qualifiers:</strong>
                <ul style="padding-left:18px; margin-top:4px;">${qListHtml}</ul>
              </div>
            </div>
          </div>
        `;

        let interactiveLayerRef = null;
        const interactiveLayer = L.geoJSON(regionFeature, {
          pane: 'regionPane',
          style: { opacity: 0, fillOpacity: 0, weight: 0 },
          onEachFeature: (_, layer) => {
            interactiveLayerRef = layer;
            layer.on('click', e => {
              if (e.originalEvent && e.originalEvent._clickedSchool) return; // ignore school clicks
              map.fitBounds(layer.getBounds());
              const center = layer.getBounds().getCenter();
              layer.bindPopup(popupContent).openPopup(center);
            });
          }
        }).addTo(schoolRegionLayer);

        // Add region to search (zoom and open its popup)
        addToIndex({
          type: 'Region',
          title: regionName,
          sub: 'Region',
          terms: regionName.toLowerCase(),
          select: () => {
            const b = interactiveLayerRef.getBounds();
            map.fitBounds(b, { padding: [20, 20] });
            const center = b.getCenter();
            interactiveLayerRef.bindPopup(popupContent).openPopup(center);
          }
        });
      });

      try { map.fitBounds(regionsVisible.getBounds(), { padding: [20,20] }); } catch (e) {}

      // ===== Wire up Search =====
      const input = document.getElementById('searchInput');
      const resultsEl = document.getElementById('results');
      let activeIndex = -1;

      function doSearch(q){
        const query = q.trim().toLowerCase();
        resultsEl.innerHTML = '';
        resultsEl.style.display = 'none';
        activeIndex = -1;
        if (!query) return;

        // simple scoring: startsWith > includes
        const matches = [];
        for (const item of searchIndex) {
          const t = item.terms || '';
          if (!t) continue;
          if (t.startsWith(query)) matches.push({score: 2, item});
          else if (t.includes(query)) matches.push({score: 1, item});
        }
        matches.sort((a,b)=> b.score - a.score || a.item.title.localeCompare(b.item.title));
        const top = matches.slice(0, 12);

        if (!top.length) return;

        for (let i=0; i<top.length; i++){
          const { item } = top[i];
          const div = document.createElement('div');
          div.className = 'result-item';
          div.dataset.idx = String(i);

          div.innerHTML = `
            <div class="result-left">
              <span class="result-type">${item.type}</span>
              <div>
                <div class="result-title">${item.title}</div>
                <div class="result-sub">${item.sub || ''}</div>
              </div>
            </div>
          `;
          div.addEventListener('click', () => {
            resultsEl.style.display = 'none';
            input.blur();
            item.select && item.select();
          });
          resultsEl.appendChild(div);
        }
        resultsEl.style.display = 'block';
      }

      input.addEventListener('input', (e)=> doSearch(e.target.value));

      input.addEventListener('keydown', (e)=>{
        const items = Array.from(resultsEl.querySelectorAll('.result-item'));
        if (!items.length) return;

        if (e.key === 'ArrowDown'){
          e.preventDefault();
          activeIndex = (activeIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp'){
          e.preventDefault();
          activeIndex = (activeIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter'){
          e.preventDefault();
          if (activeIndex >=0) items[activeIndex].click();
          return;
        } else if (e.key === 'Escape'){
          resultsEl.style.display = 'none';
          input.blur();
          return;
        } else {
          return; // let input handler run
        }

        items.forEach((el, i)=> el.classList.toggle('active', i===activeIndex));
        const activeEl = items[activeIndex];
        if (activeEl){
          const r = activeEl.getBoundingClientRect();
          const c = resultsEl.getBoundingClientRect();
          if (r.bottom > c.bottom) activeEl.scrollIntoView(false);
          if (r.top < c.top) activeEl.scrollIntoView();
        }
      });

      // Hide results when clicking map or elsewhere
      map.on('click', ()=> { resultsEl.style.display = 'none'; });
      document.addEventListener('click', (e)=>{
        if (!document.querySelector('.search-wrap').contains(e.target)) {
          resultsEl.style.display = 'none';
        }
      });
    })
    .catch(err => console.error(err));

    // Layer toggle
    L.control.layers(null, {
      "Regions & Schools": schoolRegionLayer,
      "Tournaments": tournamentLayer,
      "Qualifiers": qualifierLayer
    }, { collapsed: false }).addTo(map);
  </script>
</body>
</html>










