<!DOCTYPE html>
<html>
<head>
  <title>NCCGA Regional Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; }
    .popup-columns {
      display: flex;
      justify-content: space-between;
      gap: 30px;
    }
    .popup-columns ul {
      padding-left: 1.2em;
      margin: 0;
    }
    .popup-columns .column {
      width: 48%;
    }
    .leaflet-control-layers-expanded {
      background: white;
      padding: 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>

<script>
  const map = L.map('map').setView([39.5, -98.35], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Layer groups
  const regionLayer = L.layerGroup().addTo(map);
  const schoolLayer = L.layerGroup().addTo(map);
  const tournamentLayer = L.layerGroup().addTo(map);

  // Load GeoJSON data
  Promise.all([
    fetch('regions.geojson').then(res => res.json()),
    fetch('schools.geojson').then(res => res.json()),
    fetch('tournaments.geojson').then(res => res.json())
  ]).then(([regionsData, schoolsData, tournamentsData]) => {

    const regionSchoolsMap = {};
    schoolsData.features.forEach(f => {
      const region = f.properties.region;
      if (!regionSchoolsMap[region]) regionSchoolsMap[region] = [];
      regionSchoolsMap[region].push(f);
    });

    const regionTournamentsMap = {};
    tournamentsData.features.forEach(f => {
      const region = f.properties.region;
      if (!regionTournamentsMap[region]) regionTournamentsMap[region] = [];
      regionTournamentsMap[region].push(f);
    });

    // Render Regions
    L.geoJSON(regionsData, {
      onEachFeature: (feature, layer) => {
        layer.on('click', () => {
          const region = feature.properties.region;
          const schools = regionSchoolsMap[region] || [];
          const tournaments = regionTournamentsMap[region] || [];

          const schoolList = schools.map(s => `<li>${s.properties.school}</li>`).join('');
          const tournamentList = tournaments.length ? tournaments.map(t => `
            <li>
              <strong>${t.properties.course}</strong><br/>
              <em>${t.properties.date}</em><br/>
              <a href="${t.properties.website}" target="_blank">Course Website</a>
            </li>
          `).join('') : `<li>No tournaments scheduled.</li>`;

          const content = `
            <div style="text-align:center"><strong>${region}</strong></div>
            <div class="popup-columns">
              <div class="column">
                <strong>Schools:</strong>
                <ul>${schoolList}</ul>
              </div>
              <div class="column">
                <strong>Tournaments:</strong>
                <ul>${tournamentList}</ul>
              </div>
            </div>
          `;

          layer.bindPopup(content).openPopup();

          // Center and zoom
          map.fitBounds(layer.getBounds(), {
            padding: [50, 50]
          });

          // Center popup on screen
          const center = layer.getBounds().getCenter();
          setTimeout(() => map.panTo(center), 200); // slight delay after zoom
        });

        regionLayer.addLayer(layer);
      },
      style: {
        color: '#000',
        weight: 2,
        fillOpacity: 0.1
      }
    });

    // Render Schools
    schoolsData.features.forEach(f => {
      const coords = f.geometry.coordinates.reverse();
      const marker = L.circleMarker(coords, {
        radius: 5,
        color: 'blue',
        fillColor: '#30f',
        fillOpacity: 0.8
      }).bindPopup(f.properties.school);
      schoolLayer.addLayer(marker);
    });

    // Render Tournaments
    const flagIcon = L.icon({
      iconUrl: 'img/Golf_flag_icon.png',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    tournamentsData.features.forEach(f => {
      const coords = f.geometry.coordinates.reverse();
      const marker = L.marker(coords, { icon: flagIcon }).bindPopup(`
        <strong>${f.properties.course}</strong><br/>
        <em>${f.properties.date}</em><br/>
        <a href="${f.properties.website}" target="_blank">Course Website</a>
      `);
      tournamentLayer.addLayer(marker);
    });

    // Layer control
    const overlayMaps = {
      "Regions & Schools": L.layerGroup([regionLayer, schoolLayer]),
      "Tournaments": tournamentLayer
    };

    L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);
  });
</script>
</body>
</html>
